<%

documentroot = servername = scope.function_regsubst(@hostname, 'web-(.+)', '\1.totsy.com')
if @site and @site != 'totsy'
  servername = "#{site}-#{servername}"
end

%>
map $http_user_agent $magecode {
	default				"";
	"~ (iPhone|Android|BlackBerry)"	mobile;
}

###############################################################################
#
# totsy (insecure)
#
###############################################################################

server {
	listen 80;
	server_name <%= servername %>;

	root /var/www/<%= documentroot %>;
	index index.php index.html;
	fastcgi_index index.php;

	access_log /var/log/nginx/<%= servername %>-access.log;
	error_log  /var/log/nginx/<%= servername %>-errors.log debug;

	rewrite ^/skin/m/([0-9]+)(/.*.(js|css))$ /lib/minify/m.php?f=$2&d=$1 last;

	rewrite ^/invite/([^/\.]+)/$  /invitation/customer_account/genericcreate/invitation/$1 permanent;

	# Protect internal resources
	location ~ (/(app/|includes/|lib/|/pkginfo/|var/|report/config.xml)|/\.svn/|/.hta.+) {
		deny all;
	}

	# Try static files first
	location ~ .(css|js|gif|jpg|jpeg|png)$ {
		try_files $uri code=404;
	}

	location / {
		include /etc/nginx/fastcgi_params;
		fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        	fastcgi_param SCRIPT_NAME /index.php;
		fastcgi_param MAGE_RUN_CODE $magecode;

        	# rewrite - if file not found, pass it to the backend
        	if (!-f $request_filename) {
			fastcgi_pass 127.0.0.1:9000;
            		break;
        	}
	}
}

###############################################################################
#
# totsy (secure)
#
###############################################################################

server {
        listen 443;
	server_name <%= servername %>;

	#ssl on;
        #ssl_certificate     /etc/nginx/totsy_certs/totsy.com.crt;
        #ssl_certificate_key /etc/nginx/totsy_certs/totsy.com.key;

        root /var/www/<%= servername %>;
        index index.php index.html;
        fastcgi_index index.php;

        access_log /var/log/nginx/<%= servername %>-access.log;
        error_log  /var/log/nginx/<%= servername %>-errors.log warn;

	rewrite ^/skin/m/([0-9]+)(/.*.(js|css))$ /lib/minify/m.php?f=$2&d=$1 last;

	rewrite ^/invite/([^/\.]+)/$  /invitation/customer_account/genericcreate/invitation/$1 permanent;

	# Protect internal resources
	location ~ (/(app/|includes/|lib/|/pkginfo/|var/|report/config.xml)|/\.svn/|/.hta.+) {
		deny all;
	}

	# Try static files first
	location ~ .(css|js|gif|jpg|jpeg|png)$ {
		try_files $uri code=404;
	}

        location / {
                include /etc/nginx/fastcgi_params;
                fastcgi_param SCRIPT_FILENAME $document_root/index.php;
                fastcgi_param SCRIPT_NAME /index.php;
		fastcgi_param HTTPS on;
                # rewrite - if file not found, pass it to the backend
                if (!-f $request_filename) {
                        fastcgi_pass 127.0.0.1:9000;
                        break;
                }
        }
}
